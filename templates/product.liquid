{%- if product == blank -%}
  <section class="product-unavailable">
    <div class="product-unavailable__content">
      <h1>Product coming soon</h1>
      <p>We're preparing our next release. Please check back soon for full details.</p>
    </div>
  </section>
{%- else -%}
  <section class="product" aria-labelledby="product-title">
    <div class="product__grid">
      <div class="product__media">
        {%- if product.media.size > 0 -%}
          <div class="product__media-gallery" role="list">
            {%- for media in product.media -%}
              <figure class="product__media-item" role="listitem">
                {{
                  media
                  | media_tag:
                    class: 'product__media-image',
                    loading: 'lazy',
                    image_size: '2048x2048'
                }}
                {%- if media.alt != blank -%}
                  <figcaption class="visually-hidden">{{ media.alt }}</figcaption>
                {%- endif -%}
              </figure>
            {%- endfor -%}
          </div>
        {%- else -%}
          <div class="product__media-placeholder">No media available</div>
        {%- endif -%}
      </div>

      <div class="product__details">
        <header class="product__header">
          <h1 id="product-title">{{ product.title }}</h1>
          {%- if product.vendor != blank -%}
            <p class="product__vendor">By {{ product.vendor }}</p>
          {%- endif -%}
        </header>

        <div class="product__pricing">
          {%- assign primary_variant = product.selected_or_first_available_variant -%}
          <span class="product__price">{{ primary_variant.price | money }}</span>
          {%- if primary_variant.compare_at_price > primary_variant.price -%}
            <span class="product__price--compare">{{ primary_variant.compare_at_price | money }}</span>
          {%- endif -%}
        </div>

        {%- if product.description != blank -%}
          <div class="product__description">{{ product.description }}</div>
        {%- endif -%}

        {%- form 'product', product, class: 'product-form' -%}
          {{ form.errors | default_errors }}
          {%- if product.variants.size > 1 -%}
            <label class="product-form__label" for="VariantSelector-{{ form.id }}">Choose an option</label>
            <select
              id="VariantSelector-{{ form.id }}"
              name="id"
              class="product-form__select"
            >
              {%- for variant in product.variants -%}
                <option
                  value="{{ variant.id }}"
                  {%- if variant == product.selected_or_first_available_variant -%} selected{%- endif -%}
                  {%- unless variant.available -%} disabled{%- endunless -%}
                >
                  {{ variant.title }}{%- unless variant.available -%} — Sold out{%- endunless -%}
                </option>
              {%- endfor -%}
            </select>
          {%- else -%}
            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
          {%- endif -%}

          {{ form | payment_terms }}

          {%- assign current_price = primary_variant.price -%}
          {%- assign compare_price = primary_variant.compare_at_price -%}
          {%- if compare_price > current_price and compare_price > 0 -%}
            {%- assign discount_percentage = compare_price | minus: current_price | times: 100 | divided_by: compare_price | round -%}
          {%- endif -%}

          <div class="product-offer-highlight" data-countdown-hours="20">
            <p class="product-offer-highlight__meta">In 20+ carts</p>
            <div class="product-offer-highlight__prices">
              <span class="product-offer-highlight__price-current">{{ current_price | money }}</span>
              {%- if compare_price > current_price -%}
                <span class="product-offer-highlight__price-compare">{{ compare_price | money }}</span>
              {%- endif -%}
            </div>
            <span class="product-offer-highlight__badge">Introductory price</span>
            <div class="product-offer-highlight__footer">
              {%- if discount_percentage -%}
                <span class="product-offer-highlight__discount">{{ discount_percentage }}% off</span>
                <span aria-hidden="true" class="product-offer-highlight__separator">·</span>
              {%- endif -%}
              <span class="product-offer-highlight__timer">Sale ends in <span data-countdown-target>20:00:00</span></span>
            </div>
          </div>

          {%- if product.available -%}
            <div class="product-form__payment-button">
              {{ form | payment_button }}
            </div>
          {%- endif -%}
        {%- endform -%}
      </div>
    </div>
  </section>

  {%- render 'product-reviews' -%}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      document.querySelectorAll('.product-offer-highlight[data-countdown-hours]').forEach(function(wrapper) {
        var countdownTarget = wrapper.querySelector('[data-countdown-target]');
        if (!countdownTarget) {
          return;
        }

        var hours = parseInt(wrapper.getAttribute('data-countdown-hours'), 10);
        if (isNaN(hours) || hours <= 0) {
          return;
        }

        var deadline = Date.now() + hours * 60 * 60 * 1000;

        function updateCountdown() {
          var remaining = Math.max(0, deadline - Date.now());
          var totalSeconds = Math.floor(remaining / 1000);
          var displayHours = Math.floor(totalSeconds / 3600);
          var displayMinutes = Math.floor((totalSeconds % 3600) / 60);
          var displaySeconds = totalSeconds % 60;

          countdownTarget.textContent = [displayHours, displayMinutes, displaySeconds]
            .map(function(value) {
              return String(value).padStart(2, '0');
            })
            .join(':');

          if (remaining <= 0) {
            countdownTarget.textContent = '00:00:00';
            clearInterval(intervalId);
          }
        }

        updateCountdown();
        var intervalId = setInterval(updateCountdown, 1000);
      });
    });
  </script>
{%- endif -%}
