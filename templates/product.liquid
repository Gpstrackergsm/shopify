{%- if product == blank -%}
  <section class="product-page">
    <h1>Product unavailable</h1>
    <p>The product you're looking for could not be found.</p>
  </section>
{%- else -%}
  {%- assign selected_variant = product.selected_or_first_available_variant -%}
  <section class="product-page" aria-labelledby="product-title">
    <header class="product-page__header">
      <h1 id="product-title">{{ product.title }}</h1>
    </header>

    {%- if product.featured_image -%}
      <figure class="product-page__media">
        {{
          product.featured_image
          | image_url: width: 1024
          | image_tag:
            alt: product.featured_image.alt | default: product.title,
            class: 'product-page__image',
            loading: 'lazy'
        }}
      </figure>
    {%- endif -%}

    <div class="product-page__price">
      {{ selected_variant.price | money }}
    </div>

    {%- form 'product', product, class: 'product-page__form' -%}
      {{ form.errors | default_errors }}
      <input
        type="hidden"
        name="id"
        value="{{ selected_variant.id }}"
      >
      <input
        type="hidden"
        name="quantity"
        value="1"
      >

      <div class="product-page__actions">
        <button
          type="submit"
          name="checkout"
          value="1"
          class="button button-primary product-page__button product-page__button--buy"
          data-buy-now
          {%- unless selected_variant.available -%} disabled{%- endunless -%}
        >
          Buy now
        </button>
      </div>
    {%- endform -%}

    {%- if product.description != blank -%}
      <div class="product-page__description">
        {{ product.description }}
      </div>
    {%- endif -%}
  </section>
{%- endif -%}

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.querySelector('.product-page__form');
    if (!form || !window.fetch || !window.FormData) {
      return;
    }

    var buyNowButton = form.querySelector('[data-buy-now]');
    if (!buyNowButton) {
      return;
    }

    buyNowButton.addEventListener('click', function (event) {
      if (buyNowButton.disabled) {
        return;
      }

      event.preventDefault();

      var formData = new FormData(form);
      formData.set('quantity', '1');

      buyNowButton.disabled = true;

      fetch('{{ routes.cart_clear_url }}.js', {
        method: 'POST',
        credentials: 'same-origin'
      })
        .then(function () {
          return fetch('{{ routes.cart_add_url }}.js', {
            method: 'POST',
            credentials: 'same-origin',
            body: formData
          });
        })
        .then(function (response) {
          if (!response || !response.ok) {
            throw new Error('Unable to add item to cart');
          }

          window.location.href = '{{ routes.checkout_url }}';
        })
        .catch(function () {
          buyNowButton.disabled = false;
          form.submit();
        });
    });
  });
</script>
