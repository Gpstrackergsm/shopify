{%- liquid
  assign context_product = product
  if context_product == blank and product_handle
    assign context_product = all_products[product_handle]
  endif

  if context_product != blank
    assign selected_variant = context_product.selected_or_first_available_variant
    assign current_price = ''
    if selected_variant and selected_variant.price
      assign current_price = selected_variant.price
    else
      assign current_price = context_product.price
    endif

    assign compare_price_candidate = ''
    if selected_variant and selected_variant.compare_at_price
      assign compare_price_candidate = selected_variant.compare_at_price
    else
      assign compare_price_candidate = context_product.compare_at_price_max
    endif

    if compare_price_candidate == blank or compare_price_candidate <= current_price
      assign compare_price_candidate = ''
    endif

    assign popularity = context_product.metafields.custom.popularity_message
    if popularity == blank
      assign popularity = 'In 20+ carts'
    endif

    assign badge_text = context_product.metafields.custom.intro_badge
    if badge_text == blank
      assign badge_text = 'Introductory price'
    endif

    assign sale_prefix = context_product.metafields.custom.sale_prefix
    if sale_prefix == blank and compare_price_candidate != ''
      assign discount_ratio = compare_price_candidate | minus: current_price | times: 100.0 | divided_by: compare_price_candidate
      assign sale_prefix = discount_ratio | round | append: '% off'
    endif

    assign sale_timer = context_product.metafields.custom.sale_timer

    assign checkout_disabled = true
    if context_product.available and selected_variant
      assign checkout_disabled = false
    endif
  endif
-%}
{%- if context_product != blank -%}
<div class="buy-now-card" role="region" aria-label="Checkout offer">
  <p class="buy-now-card__status">{{ popularity }}</p>
  <div class="buy-now-card__price-row">
    <span class="buy-now-card__price">Now {{ current_price | money }}</span>
    {%- if compare_price_candidate != '' -%}
      <span class="buy-now-card__price--compare">{{ compare_price_candidate | money }}</span>
    {%- endif -%}
  </div>
  <p class="buy-now-card__badge">{{ badge_text }}</p>
  {%- if sale_prefix != blank or sale_timer != blank -%}
    <p class="buy-now-card__sale-info">
      {%- if sale_prefix != blank -%}
        <span class="buy-now-card__sale-highlight">{{ sale_prefix }}</span>
      {%- endif -%}
      {%- if sale_timer != blank -%}
        <span class="buy-now-card__sale-timer">{{ sale_timer }}</span>
      {%- endif -%}
    </p>
  {%- endif -%}
  {%- if checkout_disabled -%}
    <span class="buy-now-card__button buy-now-card__button--disabled" role="button" aria-disabled="true">Sold out</span>
  {%- else -%}
    <form method="post" action="{{ routes.cart_add_url }}" class="buy-now-card__form">
      <input type="hidden" name="form_type" value="product">
      <input type="hidden" name="utf8" value="âœ“">
      <input type="hidden" name="id" value="{{ selected_variant.id }}">
      <input type="hidden" name="quantity" value="1">
      <input type="hidden" name="return_to" value="{{ routes.checkout_url }}">
      <button type="submit" class="buy-now-card__button">Buy Now</button>
    </form>
  {%- endif -%}
</div>
{%- endif -%}
